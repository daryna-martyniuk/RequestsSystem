<Window x:Class="Requests.UI.Views.RequestDetailsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Деталі запиту" Height="800" Width="1000"
        WindowStartupLocation="CenterScreen" Background="{StaticResource BackgroundLight}">

    <Grid Margin="25">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Панель дій -->
            <RowDefinition Height="Auto"/>
            <!-- Хедер -->
            <RowDefinition Height="Auto"/>
            <!-- Інфо-панель -->
            <RowDefinition Height="*"/>
            <!-- Основний контент (Таби) -->
        </Grid.RowDefinitions>

        <!-- 0. ПАНЕЛЬ ДІЙ (Toolbar) -->
        <Border Grid.Row="0" Margin="0,0,0,20" Padding="0,0,0,10" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">

                <!-- Кнопка Редагувати -->
                <Button Content="✎ Редагувати" Command="{Binding EditCommand}" 
                        Visibility="{Binding CanEdit, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Style="{StaticResource ActionBtnStyle}" Background="{StaticResource WarningOrange}" Margin="5,0"/>

                <!-- Кнопка Скасувати -->
                <Button Content="✕ Скасувати" Command="{Binding CancelCommand}" 
                        Visibility="{Binding CanCancel, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Style="{StaticResource ActionBtnStyle}" Background="{StaticResource TextSecondary}" Margin="5,0"/>

                <!-- Кнопка Видалити -->
                <Button Content="🗑 Видалити" Command="{Binding DeleteCommand}" 
                        Visibility="{Binding CanDelete, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Style="{StaticResource ActionBtnStyle}" Background="{StaticResource DangerRed}" Margin="5,0"/>

                <!-- Кнопка Призначити виконавців (Тільки для Керівників, реалізуємо пізніше через CanManageTasks) -->
                <!-- <Button Content="👥 Виконавці" ... /> -->
            </StackPanel>
        </Border>

        <!-- 1. ХЕДЕР -->
        <Border Grid.Row="1" Margin="0,0,0,20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="★" Foreground="{StaticResource WarningOrange}" FontSize="24" Margin="0,0,5,0"
                                   Visibility="{Binding Request.IsStrategic, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        <TextBlock Text="{Binding Request.Title}" FontSize="26" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" TextWrapping="Wrap"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                        <Border Background="{StaticResource PrimaryBlue}" CornerRadius="4" Padding="6,2" Margin="0,0,10,0">
                            <TextBlock Text="{Binding Request.Category.Name}" Foreground="White" FontSize="12" FontWeight="SemiBold"/>
                        </Border>

                        <TextBlock Text="Автор: " Foreground="{StaticResource TextSecondary}"/>
                        <TextBlock Text="{Binding Request.Author.FullName}" FontWeight="SemiBold" Margin="0,0,15,0" Foreground="{StaticResource TextPrimary}"/>

                        <TextBlock Text="Створено: " Foreground="{StaticResource TextSecondary}"/>
                        <TextBlock Text="{Binding Request.CreatedAt, StringFormat='dd.MM.yyyy HH:mm'}" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Великий статус -->
                <Border Grid.Column="1" Background="{StaticResource HeaderBackground}" CornerRadius="10" Padding="25,10" VerticalAlignment="Center">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="СТАТУС" FontSize="10" Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding Request.GlobalStatus.Name}" Foreground="{StaticResource PrimaryBlue}" FontWeight="Bold" FontSize="18"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- 2. ІНФО-ПАНЕЛЬ -->
        <Grid Grid.Row="2" Margin="0,0,0,25">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0">
                <TextBlock Text="Пріоритет" Foreground="{StaticResource TextSecondary}" FontSize="12"/>
                <TextBlock Text="{Binding Request.Priority.Name}" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" FontSize="16"/>
            </StackPanel>

            <StackPanel Grid.Column="1">
                <TextBlock Text="Дедлайн" Foreground="{StaticResource TextSecondary}" FontSize="12"/>
                <TextBlock Text="{Binding Request.Deadline, StringFormat='dd.MM.yyyy', TargetNullValue='Не встановлено'}" 
                           FontWeight="Bold" Foreground="{StaticResource DangerRed}" FontSize="16"/>
            </StackPanel>

            <StackPanel Grid.Column="2">
                <TextBlock Text="Дата завершення" Foreground="{StaticResource TextSecondary}" FontSize="12"/>
                <TextBlock Text="{Binding Request.CompletedAt, StringFormat='dd.MM.yyyy', TargetNullValue='В роботі'}" 
                           FontWeight="Bold" Foreground="{StaticResource SuccessGreen}" FontSize="16"/>
            </StackPanel>
        </Grid>

        <!-- 3. ТАБИ (КОНТЕНТ) -->
        <TabControl Grid.Row="3" Background="White" BorderThickness="0">
            <TabControl.Resources>
                <Style TargetType="TabItem">
                    <Setter Property="FontSize" Value="14"/>
                    <Setter Property="Padding" Value="20,10"/>
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="TabItem">
                                <Border x:Name="Border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Margin="0,0,5,0">
                                    <ContentPresenter x:Name="ContentSite" VerticalAlignment="Center" HorizontalAlignment="Center" ContentSource="Header" Margin="10,5"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource PrimaryBlue}"/>
                                        <Setter Property="Foreground" Value="{StaticResource PrimaryBlue}"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </TabControl.Resources>

            <!-- ВКЛАДКА: ОПИС І ВИКОНАВЦІ -->
            <TabItem Header="Деталі та Виконавці">
                <Grid Margin="20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="1*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Опис (Зліва) -->
                    <ScrollViewer Grid.Column="0" Margin="0,0,30,0">
                        <StackPanel>
                            <TextBlock Text="Опис завдання" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" Margin="0,0,0,10"/>
                            <TextBlock Text="{Binding Request.Description}" TextWrapping="Wrap" FontSize="15" LineHeight="24" Foreground="#333"/>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Задачі відділів (Справа) -->
                    <Border Grid.Column="1" Background="{StaticResource BackgroundLight}" CornerRadius="10" Padding="15" VerticalAlignment="Top">
                        <StackPanel>
                            <TextBlock Text="Залучені відділи" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" Margin="0,0,0,15"/>
                            <ListBox ItemsSource="{Binding Tasks}" Background="Transparent" BorderThickness="0">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="White" CornerRadius="6" Padding="10" Margin="0,0,0,8" BorderBrush="#E0E0E0" BorderThickness="1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Department.Name}" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}"/>
                                                    <TextBlock Text="{Binding AssignedAt, StringFormat='Призначено: dd.MM'}" FontSize="10" Foreground="{StaticResource TextSecondary}"/>
                                                </StackPanel>
                                                <TextBlock Grid.Column="1" Text="{Binding Status.Name}" FontSize="12" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ВКЛАДКА: ФАЙЛИ -->
            <TabItem Header="Вкладення">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Кнопка додати файл (тільки при редагуванні) -->
                        <RowDefinition Height="*"/>
                        <!-- Список -->
                    </Grid.RowDefinitions>

                    <!-- Список файлів -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding Attachments}" BorderThickness="0" Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource BackgroundLight}" CornerRadius="8" Padding="15" Margin="0,0,0,10" Width="500" HorizontalAlignment="Left">
                                    <DockPanel>
                                        <Button Content="⬇ Завантажити" Command="{Binding DataContext.DownloadFileCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                CommandParameter="{Binding}" DockPanel.Dock="Right"
                                                Style="{StaticResource ActionBtnStyle}" Background="{StaticResource PrimaryBlue}" Height="30" FontSize="12"/>

                                        <StackPanel VerticalAlignment="Center">
                                            <TextBlock Text="📎" FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center" DockPanel.Dock="Left"/>
                                            <TextBlock Text="{Binding FileName}" FontWeight="Bold" Foreground="{StaticResource TextPrimary}"/>
                                            <TextBlock Text="{Binding UploadedAt, StringFormat='Завантажено: dd.MM.yyyy HH:mm'}" FontSize="11" Foreground="{StaticResource TextSecondary}"/>
                                        </StackPanel>
                                    </DockPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Якщо пусто -->
                    <TextBlock Grid.Row="1" Text="Немає вкладених файлів" Foreground="{StaticResource TextSecondary}" 
                               HorizontalAlignment="Center" VerticalAlignment="Center" 
                               Visibility="{Binding Attachments.Count, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverted}"/>
                </Grid>
            </TabItem>

            <!-- ВКЛАДКА: КОМЕНТАРІ -->
            <TabItem Header="Коментарі">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ListBox ItemsSource="{Binding Comments}" BorderThickness="0" Background="Transparent" Margin="0,0,0,15">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource BackgroundLight}" CornerRadius="10" Padding="15" Margin="0,0,0,10" BorderThickness="0">
                                    <StackPanel>
                                        <DockPanel LastChildFill="False" Margin="0,0,0,5">
                                            <TextBlock Text="{Binding User.FullName}" FontWeight="Bold" Foreground="{StaticResource PrimaryBlue}"/>
                                            <TextBlock Text="{Binding CreatedAt, StringFormat='dd.MM HH:mm'}" Foreground="{StaticResource TextSecondary}" FontSize="11" DockPanel.Dock="Right"/>
                                        </DockPanel>
                                        <TextBlock Text="{Binding CommentText}" TextWrapping="Wrap" Foreground="{StaticResource TextPrimary}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{Binding NewCommentText, UpdateSourceTrigger=PropertyChanged}" Height="50" Tag="Напишіть коментар..." VerticalContentAlignment="Top"/>
                        <Button Grid.Column="1" Content="Надіслати" Command="{Binding AddCommentCommand}" 
                                Style="{StaticResource ActionBtnStyle}" Margin="15,0,0,0" Width="100" Height="50"/>
                    </Grid>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</Window>